---
title: "Apartment Rent Analysis"
output: pdf_document
date: "2022-12-14"
---

```{r}
require(splines)
require(glmnet)
require(viridis)
require(nortest)
require(lmtest)
require(caret)
require(multcomp)
require(broom)
require(tidyverse)
require(mgcv)
require(genlasso)
set.seed(93)
```


```{r}
apartment_full <- read.csv("full_sqft.csv")
head(apartment_full)
```

```{r}
apartment_selected <- apartment_full %>% select(-address, -city, -name, -state, -bath_count, -bed_count)
apartment_selected <- apartment_selected %>% mutate(shopping.num = as.factor(shopping.num), zip = as.factor(zip),
                                                    count.pub.high = as.factor(count.pub.high), 
                                                    pub.elt.mid = as.factor(pub.elt.mid), 
                                                    priv.elt.mid = as.factor(priv.elt.mid),
                                                    priv.el.hi = as.factor(priv.el.hi),
                                                    priv.elt.mid.hi = as.factor(priv.elt.mid.hi),
                                                    air.level = as.factor(air.level),
                                                    base.num = as.factor(base.num),
                                                    busi.level = as.factor(busi.level),
                                                    has.covered = as.factor(has.covered),
                                                    has.garage = as.factor(has.garage),
                                                    has.lot = as.factor(has.lot),
                                                    has.street = as.factor(has.street),
                                                    neighborhood = as.factor(neighborhood),
                                                    pet.allowed = as.factor(pet.allowed),
                                                    traffic.level = as.factor(traffic.level),
                                                    has.parking = as.factor(has.parking),
                                                    has.pub.elementary = as.factor(has.pub.elementary),
                                                    has.priv.elementary = as.factor(has.priv.elementary),
                                                    has.pub.mid = as.factor(has.pub.mid),
                                                    has.cha.high = as.factor(has.cha.high),
                                                    has.priv.high = as.factor(has.priv.high),
                                                    has.cha.mid.high = as.factor(has.cha.mid.high),
                                                    has.priv.mid.high = as.factor(has.priv.mid.high),
                                                    has.pub.mid.high = as.factor(has.pub.mid.high),
                                                    priv.el.hi = as.factor(priv.el.hi),
                                                    cha.elt.mid.hi = as.factor(cha.elt.mid.hi),
                                                    priv.elt.mid.hi = as.factor(priv.elt.mid.hi),
                                                    sqft.regressed = as.factor(sqft.regressed))
apartment_selected$neighborhood <- gsub("\\s+", "", apartment_selected$neighborhood)
apartment_selected$neighborhood <- gsub("[^[:alnum:] ]", "", apartment_selected$neighborhood)
```

```{r}
sapply(apartment_selected, function(x) {return(length(levels(x)))})
```

```{r}
apartment_selected <- apartment_selected %>% select(sqft, zip, neighborhood, baths, beds, sqft.regressed, has.covered, has.garage, has.lot, has.street, rent) %>% mutate(zip = as.factor(zip), 
                                                                                                                                                                         baths = as.factor(baths),
                                                                                                                                                                         beds = as.factor(beds),
                                                                                                                                                                         neighborhood = as.factor(neighborhood))
```


```{r}
apartment_test_idx <- sample(1:nrow(apartment_selected), 3368)
apartment_test <- apartment_selected[apartment_test_idx, ]
apartment_train <- apartment_selected[-apartment_test_idx, ]
```


```{r}
apartment_train_shuffled <- apartment_train[sample(1:nrow(apartment_train)), ]
apartment_folds <- groupKFold(1:nrow(apartment_train_shuffled), 10)
```

```{r}
ggplot(apartment_train, aes(x = sqft, y = rent)) + geom_point() + geom_smooth(method = "gam")
ggplot(apartment_train, aes(x = sqft, y = log(rent))) + geom_point() + geom_smooth(method = "gam")
ggplot(apartment_train, aes(x = log(sqft), y = rent)) + geom_point() + geom_smooth(method = "gam")
ggplot(apartment_train, aes(x = log(sqft), y = log(rent))) + geom_point() + geom_smooth(method = "gam")
```


```{r}
full.mod <- lm(rent ~ ., apartment_train)
summary(full.mod)
plot(full.mod)
```

```{r}
full.mod.log <- lm(log(rent) ~ ., apartment_train)
summary(full.mod.log)
plot(full.mod.log)
```

```{r}
full.mod.log.2 <- lm(log(rent) ~ . - sqft + log(sqft), apartment_train)
summary(full.mod.log.2)
plot(full.mod.log.2)
```


```{r warning=FALSE}
gam.mod.log <- gam(log(rent) ~ s(log(sqft), k = 601, m = 2) +  neighborhood + zip + baths + beds + sqft.regressed + has.covered + has.garage + has.lot + has.street, data = apartment_train)
gam.check(gam.mod.log)
summary(gam.mod.log)
```

```{r}
plot(gam.mod.log)
```

```{r}
prep_fuse_lasso_mat <- function(apartment_train_ord) {
  apartment_train.mat <- as.data.frame(model.matrix(rent ~ . + log(sqft) - sqft, apartment_train_ord)[, -1]) %>% mutate(rent = apartment_train_ord$rent)
  max.logsqft <- max(apartment_train.mat$`log(sqft)`)
  min.logsqft <- min(apartment_train.mat$`log(sqft)`)
  qlogsqft <- (apartment_train.mat$`log(sqft)` - min.logsqft) / (max.logsqft - min.logsqft)
  apartment_train.mat$qlogsqft <- qlogsqft
  apartment_train.mat <- apartment_train.mat %>% select(-`log(sqft)`)
  full.mod.varrank <- lm(log(rent) ~ ., apartment_train.mat)
  
  apartment_train.mat <- as.data.frame(model.matrix(rent ~ . - sqft, apartment_train_ord)) %>% mutate(rent = apartment_train_ord$rent)
  zip_coefficients <- full.mod.varrank$coefficients[names(full.mod.varrank$coefficients)[grepl("zip", names(full.mod.varrank$coefficients), fixed = TRUE)]]
  zip_na_idx <- is.na(zip_coefficients)
  zip_nna <- zip_coefficients[!zip_na_idx]
  zip_na <- zip_coefficients[zip_na_idx]
  apartment_train_lasso <- data.frame(intercept = apartment_train.mat[, 1])
  apartment_train_lasso <- cbind(apartment_train_lasso, apartment_train.mat[, names(zip_na)])
  gen.lasso.edges <- cbind(rep(1, length(zip_na)), 2:(1 + length(zip_na)))

  zip_nna <- zip_nna[order(zip_nna)]
  gen.lasso.edges.temp <- cbind(rep(1, length(zip_nna)), (1:length(zip_nna)) + ncol(apartment_train_lasso))
  gen.lasso.edges <- rbind(gen.lasso.edges, gen.lasso.edges.temp)
  gen.lasso.edges.temp <- cbind(ncol(apartment_train_lasso) + (1:(length(zip_nna) - 1)), ncol(apartment_train_lasso) + (2:length(zip_nna)))
  gen.lasso.edges <- rbind(gen.lasso.edges, gen.lasso.edges.temp)
  apartment_train_lasso <- cbind(apartment_train_lasso, apartment_train.mat[, names(zip_nna)])
  
  neighbor_coefficients <- full.mod.varrank$coefficients[names(full.mod.varrank$coefficients)[grepl("neighborhood", names(full.mod.varrank$coefficients), fixed = TRUE)]]
  neighbor_na_idx <- is.na(neighbor_coefficients)
  neighbor_nna <- neighbor_coefficients[!neighbor_na_idx]
  neighbor_na <- neighbor_coefficients[neighbor_na_idx]
  gen.lasso.edges.temp <- cbind(rep(1, length(neighbor_na)), (1:length(neighbor_na)) + ncol(apartment_train_lasso))
  gen.lasso.edges <- rbind(gen.lasso.edges, gen.lasso.edges.temp)
  apartment_train_lasso <- cbind(apartment_train_lasso, apartment_train.mat[, names(neighbor_na)])

  gen.lasso.edges.temp <- cbind(rep(1, length(neighbor_nna)), (1:length(neighbor_nna)) + ncol(apartment_train_lasso))
  gen.lasso.edges <- rbind(gen.lasso.edges, gen.lasso.edges.temp)
  gen.lasso.edges.temp <- cbind(ncol(apartment_train_lasso) + (1:(length(neighbor_nna) - 1)), ncol(apartment_train_lasso) + (2:length(neighbor_nna)))
  gen.lasso.edges <- rbind(gen.lasso.edges, gen.lasso.edges.temp)
  apartment_train_lasso <- cbind(apartment_train_lasso, apartment_train.mat[, names(neighbor_nna)])
  
  lasso.colnames <- c(names(zip_na), names(zip_nna), names(neighbor_na), names(neighbor_nna))
  colnames(apartment_train_lasso) <- lasso.colnames
  lasso.unincl <- names(full.mod.varrank$coefficients)[!names(full.mod.varrank$coefficients) %in% colnames(apartment_train_lasso)]
  lasso.unincl <- lasso.unincl[-c(1, length(lasso.unincl))]
  gen.lasso.edges.temp <- cbind(rep(1, length(lasso.unincl)), (1:length(lasso.unincl)) + ncol(apartment_train_lasso))
  gen.lasso.edges <- rbind(gen.lasso.edges, gen.lasso.edges.temp)
  apartment_train_lasso <- cbind(apartment_train_lasso, apartment_train.mat[, lasso.unincl])
  apartment_train_lasso$qlogsqft <- qlogsqft
  return(list(X = apartment_train_lasso, graph = gen.lasso.edges))
}
```


```{r}
apartment_train_ord <- apartment_train %>% mutate(beds = as.numeric(beds), baths = as.numeric(baths)) %>% mutate(beds1 = beds >= 1, beds2 = beds >= 2, beds3 = beds >=3, beds4 = beds >=4) %>%
                                           mutate(baths1.5 = baths >= 1.5, baths2 = baths >= 2, baths2.5 = baths >= 2.5, baths3 = baths >= 3, baths3.5 = baths >= 3.5, baths4 = baths >= 4)
apartment_train_ord <- apartment_train_ord %>% select(-beds, -baths)

```


```{r}
apartment_fuse_lasso <- prep_fuse_lasso_mat(apartment_train_ord)
penal_graph <- graph_from_edgelist(apartment_fuse_lasso$graph, directed = FALSE)
penal_graph <- add_vertices(penal_graph, 1)
fuse_lasso_path <- fusedlasso(log(apartment_train_ord$rent), X = as.matrix(apartment_fuse_lasso$X), graph = penal_graph)
```


```{r}
plot(fuse_lasso_path)
```


```{r}

```

